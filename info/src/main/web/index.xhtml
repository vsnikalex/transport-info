<?xml version="1.0" encoding="UTF-8"?>
<ui:composition
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:ui="http://java.sun.com/jsf/facelets"
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:composite="http://xmlns.jcp.org/jsf/composite"
        template="/WEB-INF/templates/default.xhtml">
   <ui:define name="drivers">
      <script type="text/javascript" src="resources/js/sse.js"></script>
      <script>
         EventSource = SSE;

         const source = new SSE("http://localhost:8080/info/rest/cdievents");

         source.addEventListener('drivers stat', function(e) {
            let ds = JSON.parse(e.data);

            document.getElementById('ds_available').innerHTML = ds.available;
            document.getElementById('ds_driving').innerHTML = ds.driving;
            document.getElementById('ds_others').innerHTML = ds.others;
            document.getElementById('ds_total').innerHTML = ds.total;
         });

         source.addEventListener('trucks stat', function(e) {
            let ts = JSON.parse(e.data);

            document.getElementById('ts_available').innerHTML = ts.available;
            document.getElementById('ts_inUse').innerHTML = ts.inUse;
            document.getElementById('ts_defective').innerHTML = ts.defective;
            document.getElementById('ts_total').innerHTML = ts.total;
         });

         source.addEventListener('delivery list', function(e) {
            let deliveryList = JSON.parse(e.data);

            $("#delivery_data").empty();

            deliveryList.deliveries.forEach(delivery => {
               var tableRef = document.getElementById('delivery_table').getElementsByTagName('tbody')[0];
               var newRow   = tableRef.insertRow();

               newRow.insertCell(0).innerHTML = delivery.id;

               newRow.insertCell(1).innerHTML = delivery.truck;

               let cargoCell = newRow.insertCell(2);
               let ulCargoes = document.createElement("ul");
               ulCargoes.style.cssText = "margin: 0; padding: 0; list-style-position: inside; list-style-type: none";
               delivery.cargoes.forEach(cargo => {
                  let li = document.createElement("li");
                  li.innerHTML = cargo;
                  ulCargoes.appendChild(li);
               });
               cargoCell.appendChild(ulCargoes);

               let driverCell = newRow.insertCell(3);
               let ulDrivers = document.createElement("ul");
               ulDrivers.style.cssText = "margin: 0; padding: 0; list-style-position: inside; list-style-type: none";
               delivery.drivers.forEach(driver => {
                  let li = document.createElement("li");
                  li.innerHTML = driver;
                  ulDrivers.appendChild(li);
               });
               driverCell.appendChild(ulDrivers);

               newRow.insertCell(4).innerHTML = delivery.route;
            });
         });

         source.stream();
      </script>
      <div class="tc-note tc-note-info">
         <table class="table table-small">
            <thead>
            <tr>
               <th>Drivers</th>
               <th><span class="sr-only">Preis Spalte</span></th>
            </tr>
            </thead>
            <tbody>
            <tr>
               <td>Available</td>
               <td id="ds_available" class="numeric"></td>
            </tr>
            <tr>
               <td>Driving</td>
               <td id="ds_driving" class="numeric"></td>
            </tr>
            <tr>
               <td>Other work</td>
               <td id="ds_others" class="numeric"></td>
            </tr>
            </tbody>
            <tfoot>
            <tr>
               <td colspan="4" class="numeric text-brand text-semibold">
                  Total: <span id="ds_total"></span>
               </td>
            </tr>
            </tfoot>
         </table>
      </div>
   </ui:define>
   <ui:define name="trucks">
      <div class="tc-note tc-note-info">
         <table class="table table-small">
            <thead>
            <tr>
               <th>Trucks</th>
               <th><span class="sr-only">Preis Spalte</span></th>
            </tr>
            </thead>
            <tbody>
            <tr>
               <td>Available</td>
               <td id="ts_available" class="numeric"></td>
            </tr>
            <tr>
               <td>In use</td>
               <td id="ts_inUse" class="numeric"></td>
            </tr>
            <tr>
               <td>Defective</td>
               <td id="ts_defective" class="numeric"></td>
            </tr>
            </tbody>
            <tfoot>
            <tr>
               <td colspan="4" class="numeric text-brand text-semibold">
                  Total: <span id="ts_total"></span>
               </td>
            </tr>
            </tfoot>
         </table>
      </div>
   </ui:define>
   <ui:define name="deliveries">
      <table id="delivery_table" class="table table-hover">
         <caption>Deliveries</caption>
         <thead>
         <tr>
            <th>#</th>
            <th>Truck</th>
            <th>Cargoes</th>
            <th>Drivers</th>
            <th>Route</th>
         </tr>
         </thead>
         <tbody id="delivery_data">
            <tr>
               <td id="delivery_id">
                  12
               </td>
               <td id="delivery_truck_plate">
                  HL12367
               </td>
               <td>
                  <ul id="delivery_cargoes" style="margin: 0; padding: 0; list-style-position: inside; list-style-type: none">
                     <li>#12 IKEA Table</li>
                  </ul>
               </td>
               <td>
                  <ul id="delivery_drivers" style="margin: 0; padding: 0; list-style-position: inside; list-style-type: none">
                     <li>#10 Igor Lesnoy</li>
                  </ul>
               </td>
               <td id="delivery_route">
                  Berlin &#8594; Rome &#8594; Paris &#8594; Berlin
               </td>
            </tr>
         </tbody>
      </table>
   </ui:define>
</ui:composition>
